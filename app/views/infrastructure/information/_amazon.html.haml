-# local variables: experiment, user
- amazon_secrets_creds = AmazonSecrets.find_by_user_id(user.id)
- amazon_ami_creds = AmazonAmi.find_all_by_user_id(user.id)
- if amazon_ami_creds.empty?
  -  amazon_ami_creds = nil
- else
  - amazon_ami_creds = amazon_ami_creds.select{|ami| ami.experiment_id.to_s == experiment.id.to_s}.first

.row
  #amazon-ajax-response.alert-box.radius(style="display: none;")

.row
  %dl.accordion(data-accordion="")
    %dd
      %a(href='#amazon-submission-panel')= t 'infrastructure.information.submission_label'
      .content#amazon-submission-panel
        %p
          = form_tag schedule_simulation_managers_infrastructure_path, remote: true, class: 'custom' do
            = hidden_field_tag 'experiment_id', experiment.id
            = hidden_field_tag 'infrastructure_type', 'amazon'
            = hidden_field_tag 'security_group', 'quicklaunch-1'

            .row
              .small-4.columns
                = label_tag :job_counter, t('infrastructure.information.instance_counter') + ':', class: 'inline right'
              .small-4.columns
                = text_field_tag :job_counter
              .small-4.columns
            - images = AmazonAmi.all.map{|i| ["#{i.ami_id} --- #{i.login}", i.id]}
            .row
              .small-4.columns
                = label_tag :image_id, t('.image_label') + ':', class: 'inline right'
              .small-4.columns
                = select_tag :image_id, options_for_select(images)
              .small-4.columns
            .row
              .small-4.columns
                = label_tag :instance_type, t('.vm_type') + ':', class: 'inline right'
              .small-4.columns
                = select_tag :instance_type, options_for_select(AmazonVm.amazon_instance_types)
              .small-4.columns
            .row
              .small-4.columns
                = label_tag :time_limit, t('infrastructure.information.time_constraint') + ':', class: 'inline right'
              .small-4.columns
                = text_field_tag :time_limit
              .small-4.columns

            .row
              .small-4.columns
                = label_tag :start_at, t('infrastructure.information.start_at') + ':', class: 'inline right'
              .small-4.columns
                = text_field_tag :start_at
              .small-4.columns

            .row
              .small-12.columns.text-center
                = submit_tag t('infrastructure.information.submit'), class: 'button radius'
                = image_tag 'loading.gif', class: 'amazon-submission-busy', style: 'display: none;'

            .row
              .small-12.columns
                #amazon-submission-ajax-response
    %dd
      %a(href='#amazon-credentials-panel')= t('infrastructure.information.credentials_label')
      .content#amazon-credentials-panel
        %p
          = form_tag add_infrastructure_credentials_infrastructure_path, remote: true, class: 'custom' do
            = hidden_field_tag 'infrastructure_type', 'amazon'
            = hidden_field_tag 'credential_type', 'secrets'

            %h5.subheader= t('.credentials_label')

            %fieldset
              %legend= t('.credentials.secrets')
              .row
                .small-4.columns
                  = label_tag :access_key, t('.credentials.secrets') + ':', class: 'inline right'
                .small-4.columns
                  = text_field_tag :access_key, amazon_secrets_creds.nil? ? '' : amazon_secrets_creds.access_key
                .small-4.columns
              .row
                .small-4.columns
                  = label_tag :secret_access_key, t('.credentials.secret_key') + ':', class: 'inline right'
                .small-4.columns
                  = text_field_tag :secret_access_key, amazon_secrets_creds.nil? ? '' : amazon_secrets_creds.secret_key
                .small-4.columns
              .row
                .small-4.columns
                  = label_tag :store_secrets_in_session, t('.credentials.store_in_session') + ':', class: 'inline right'
                .small-4.columns
                  = check_box_tag :store_secrets_in_session, '1', true
                .small-4.columns
              .row
                .small-12.columns.text-center
                  = submit_tag t('infrastructure.information.submit') , class: 'button radius'
                  = image_tag 'loading.gif', class: 'amazon-credentials-busy', style: 'display: none;'

          = form_tag add_infrastructure_credentials_infrastructure_path, remote: true, class: 'custom' do
            = hidden_field_tag 'infrastructure_type', 'amazon'
            = hidden_field_tag 'credential_type', 'ami'
            = hidden_field_tag 'experiment_id', experiment.id

            %fieldset
              %legend= t('.images_label')
              .row
                .small-4.columns
                  = label_tag :ami_id, t('.images.image_id') + ':', class: 'inline right'
                .small-4.columns
                  = text_field_tag :ami_id, amazon_ami_creds.nil? ? '' : amazon_ami_creds.ami_id
                .small-4.columns
              .row
                .small-4.columns
                  = label_tag :ami_login, t('.images.login') + ':', class: 'inline right'
                .small-4.columns
                  = text_field_tag :ami_login, amazon_ami_creds.nil? ? '' : amazon_ami_creds.login
                .small-4.columns
              .row
                .small-4.columns
                  = label_tag :ami_password, t('.images.password') + ':', class: 'inline right'
                .small-4.columns
                  = password_field_tag :ami_password, amazon_ami_creds.nil? ? '' : amazon_ami_creds.password
                .small-4.columns
              .row
                .small-4.columns
                  = label_tag :store_ami_in_session, t('.credentials.store_in_session') + ':', class: 'inline right'
                .small-4.columns
                  = check_box_tag :store_ami_in_session, '1', false
                .small-4.columns

              .row
                .small-12.columns.text-center
                  = submit_tag t('infrastructure.information.submit'), class: 'button radius'
                  = image_tag 'loading.gif', class: 'amazon-credentials-busy', style: 'display: none;'

    %dd
      %a(href='#amazon-vms-panel')= t('infrastructure.information.scheduled_label')
      .content#amazon-vms-panel
        %p
          %p= @current_states[:amazon]
          %ul.circle
            - @simulation_managers[:amazon].each do |virtual_machine|
              %li= virtual_machine

:javascript
  $(function() {
    //if(#{ amazon_secrets_creds.nil? } || #{ amazon_ami_creds.nil? }) {
    //  $('#plgrid-submission-tab form').addClass('disabled');
    //  $('#plgrid-login-tab').addClass('active');
    //}
    //else {
    //  $('#plgrid-submission-tab').addClass('active');
    //}
    new window.AmazonManager('#extension-dialog');

    $('p').each(function(index, element) {
      if($(element).html() == "") {
        $(element).remove();
      }
    });
  });
