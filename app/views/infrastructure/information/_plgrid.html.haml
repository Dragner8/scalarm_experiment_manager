- user = @scalarm_user || @current_user
- credentials = GridCredentials.find_by_user_id(user.id)

%div{ id: 'plgrid-login-form', class: 'wide-label' }
  %h5.subheader= 'Please, provide credentials to access PL-Grid'

  .row
    .small-4.columns
      = label_tag 'PL-Grid access host:', nil, class: 'inline'
    .small-8.columns
      = text_field_tag :plgrid_host, credentials.nil? ? '' : credentials.host
  .row
    .small-4.columns
      = label_tag 'Username:', nil, class: 'inline'
    .small-8.columns
      = text_field_tag :plgrid_username, credentials.nil? ? '' : credentials.login
  .row
    .small-4.columns
      = label_tag 'Password:', nil, class: 'inline'
    .small-8.columns
      = password_field_tag :plgrid_password, credentials.nil? ? '' : credentials.password
  .row
    .small-4.columns
      = label_tag 'Save settings:', nil, class: 'inline'
    .small-8.columns
      = check_box_tag :plgrid_save_settings, '1', (not credentials.nil?)

  .row
    %ul.inline-list
      %li= submit_tag 'Submit', class: 'button'
      %li= image_tag 'loading.gif', id: 'plgrid-configure-busy', style: 'display: none;'

= form_tag '', class: 'custom' do
  %div{ id: 'plgrid-booster-form', class: 'wide-label' }
    %p{ id: 'plgrid_info' }

    .row
      .small-3.columns
        = label_tag 'Number of jobs:', nil, class: 'inline'
      .small-9.columns
        = text_field_tag :job_counter
    .row
      .small-3.columns
        = label_tag 'Scheduler:', nil, class: 'inline'
      .small-9.columns
        = select_tag :scheduler, options_for_select([ ['Portable Batch System', 'qsub'], ['gLite', 'glite'] ])
    .row
      .small-5.columns
        = label_tag 'Job time constraint [min]:', nil, class: 'inline'
      .small-7.columns
        = text_field_tag :time_limit

    .row
      %ul.inline-list
        %li= submit_tag 'Submit', class: 'button'
        %li= button_to_function 'Edit credentials', "$('#plgrid-booster-form').hide(); $('#plgrid-login-form').show();", class: 'button'

:javascript
  $(function() {
    if(#{ credentials.nil?}) {
      $('#plgrid-booster-form').hide();
    } else {
      $('#plgrid-login-form').hide();
    }

    $("#plgrid-login-form input[type='submit']").bind('click', function() {
      $('#plgrid-configure-busy').show();

      data = {
        'host': $('#plgrid_host').val(),
        'username': $('#plgrid_username').val(),
        'password': $('#plgrid_password').val(),
        'save_settings': $('#plgrid_save_settings').prop('checked'),
        'infrastructure_type': 'plgrid',
        'authenticity_token': '#{form_authenticity_token}'
      };

      $.post("#{ add_infrastructure_credentials_infrastructure_path }", data,
            function(response) {
              if(response.status == 'ok') {
                $('#plgrid-login-form').hide();
                $('#plgrid-booster-form').show();
              }
              $('#plgrid-configure-busy').hide();
            }, 'json');

      return false;
    });
    //'user_id': #{session[:user]},
    $("#plgrid-booster-form input[type='submit']").bind('click', function() {
      data = {
        'infrastructure_type': 'plgrid',
        'experiment_id': #{experiment.id},
        'job_counter': $('#job_counter').val(),
        'time_limit': $('#time_limit').val(),
        'scheduler': $('#scheduler').val(),
        'authenticity_token': '#{form_authenticity_token}'
      };
      $.post("#{ schedule_simulation_managers_infrastructure_path }", data,
      function(response) {
          booster.onSuccess(response.msg);
      }, 'json');
      booster.afterSubmit();

      return false;
    });
  });
