- credentials = GridCredentials.find_by_user_id(user.id)

%div{ id: 'plgrid-login-form', class: 'wide-label' }
  %h3= 'Please, provide credentials to access PL-Grid'
  %div
    = label_tag '', 'PL-Grid access host:'
    = text_field_tag :host, ''
  %div
    = label_tag '', 'Username:'
    = text_field_tag :username, ''
  %div
    = label_tag '', 'Password:'
    = password_field_tag :password, ''
  %div
    = label_tag :save_settings, 'Save settings:'
    = check_box_tag :save_settings, '1'
  %br
  .buttons
    = submit_tag 'Submit'
    = image_tag 'loading.gif', id: 'plgrid-configure-busy', style: 'display: none;'

%br

%div{ id: 'plgrid-booster-form', class: 'wide-label' }
  %p{ id: 'plgrid_info' }
  %div
    %label Number of jobs:
    = text_field_tag :job_counter
  %div
    %label Job time constraint [min]:
    = text_field_tag :time_limit
  .buttons
    = submit_tag 'Submit'

:javascript
  $(function() {
    if(#{ credentials.nil?}) {
      $('#plgrid-booster-form').hide();
    } else {
      $('#plgrid-login-form').hide();
    }

    $("#plgrid-login-form input[type='submit']").bind('click', function() {
      $('#plgrid-configure-busy').show();

      data = {
        'host': $('#host').val(),
        'username': $('#username').val(),
        'password': $('#password').val(),
        'save_settings': $('#save_settings').prop('checked'),
        'infrastructure_type': 'plgrid',
        'user_id': #{session[:user]},
        'authenticity_token': '#{form_authenticity_token}'
      };

      $.post("#{ add_infrastructure_credentials_infrastructure_path }", data,
            function(response) {
              if(response.status == 'ok') {
                $('#plgrid-login-form').hide();
                $('#plgrid-booster-form').show();
              }
              $('#plgrid-configure-busy').show();
            }, 'json');

      return false;
    });

    $("#plgrid-booster-form input[type='submit']").bind('click', function() {
      data = {
        'infrastructure_type': 'plgrid',
        'experiment_id': #{experiment.id},
        'user_id': #{session[:user]},
        'job_counter': $('#job_counter').val(),
        'time_limit': $('#time_limit').val(),
        'authenticity_token': '#{form_authenticity_token}'
      };
      $.post("#{ schedule_simulation_managers_infrastructure_path }", data,
      function(response) {
          booster.onSuccess(response.msg);
      }, 'json');
      booster.afterSubmit();

      return false;
    });
  });
