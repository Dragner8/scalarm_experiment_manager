<% if params[:operation] == "destroy" %>
    var vm_node = $jit.Graph.Util.getNode(infrastructure_tree.graph, 'amazon-vm-<%= @vm_id %>');
    var parentChildrenCount = 0;
    var parentNode = $jit.Graph.Util.getParents(vm_node)[0];

    infrastructure_tree.removeSubtree('amazon-vm-<%= @vm_id %>', true, 'replot', { } );
    parentNode.eachSubnode(function(subnode) { parentChildrenCount += 1; })

    if(parentChildrenCount == 0) {
        infrastructure_tree.removeSubtree(parentNode.id, true, 'replot', { } );
    }

<% else %>
    $("#amazon-vm-<%= @vm_id %>").html("<%= escape_javascript render(:partial => "amazon_vm_node", :locals => {:vm_instance_id => @vm_id, :vm_status => @vm_status}) %>");
<% end %>