- content_for :title, 'Scalarm - monitoring'
- content_for :help, raw(t('help.experiments.monitoring'))

= render 'experiment_links'
= render 'analysis_charts'

-#.row(data-equalizer="")
= content_for :panel do
  .nano(style="overflow: hidden;")
    %section.row.panel.radius.nano-content(style="padding-left: 15px; padding-right: 8px;")
      %h3.text-center
        Experiment tools
      .action-button(style="margin-left: 10px;")
        %a.running_experiments_link(href="#" data-action-url="#{running_experiments_experiments_path}" style="display: block")
          = image_tag "material_design/running_experiments_icon.png"
          = t('experiments.experiment_links.running_experiments')
        %a.available_experiments_link(href="#" data-action-url="#{simulations_simulation_scenarios_path}" style="display: block")
          = image_tag "material_design/simulation_scenarios_icon.png"
          = t('experiments.experiment_links.simulation_scenarios')
        %a.historical_experiments_link(href="#" data-action-url="#{historical_experiments_experiments_path}" style="display: block")
          = image_tag "material_design/historical_experiments_icon.png"
          = t('experiments.experiment_links.historical_experiments')
      %hr
      %h3.text-center
        Analyses
      .analyses-panel{style: "text-align: center"}
        %p.histogram-analysis
          = image_tag "material_design/histogram_icon.png"
          %br
          %a Histogram
        %p.rtree-analysis
          = image_tag "material_design/regression_icon.png"
          %br
          %a Regression trees
        %p.bivariate-analysis
          = image_tag "material_design/scatter_icon.png"
          %br
          %a Scatter plot

%section
  %section.row.panel.radius
    = render 'information_panel'

  - if @experiment.is_running
    %section.panel.radius
      %h3.subheader
        Computational resources summary
        = image_tag('loading.gif', id: 'actions-loading-workers')
      = render 'workers_info'

  %section.row.panel.radius.last-element#monitoring_section
    %h3.subheader= t('experiments.show.stats_header')

    .content(style="padding-top: 30px; position: relative;" )


      = render 'monitoring_stats'
      .speedometer{id: "speedometer_#{@experiment.id}"}

      %article#experiment_progress_bar(style="padding-top: 50px; margin-bottom: 40px" )
        %h4.subheader= t('.progress_bar_header')

      = render 'monitoring_actions'

  %section.row.panel.radius.last-element#progressInformationWrapper(style="display: none; margin-top: 50px;")
    = render 'monitoring_table'

  = render 'scheduling_policy_dialog'

- content_for :javascript do
  :javascript
    $(function() {
      var booster = new window.ExperimentBooster('booster_dialog');

      new window.ExperimentSpeedometer('#{@experiment.id}').show();

      var monitor = new window.ExperimentMonitor('#{@experiment.id}');
      monitor.generate_html('experiment_stats');

      window.toggle_panels_on_title_click();

      $("#panel .analyses-panel").load("/chart/panel?id=#{@experiment.id}", function(response, status, xhr) {
        if(status==="error") {
          console.log("No available Chart Service. Using on-site content.");
        }
        if(!navigator.userAgent.match(/Firefox|SeaMonkey/i))
          $(".nano").nanoScroller();
      });
      $(document).foundation();

      window.WebSocket = window.WebSocket || window.MozWebSocket;

      try {
        //TODO - insert appropriate address
        var ws = new WebSocket("wss://172.16.67.206/chart/experiment_progress/#{@experiment.id}");
        window.onbeforeunload = function() {
          //Connection closed on Download simulation manager!!
          ws.onclose = function () {}; // disable onclose handler first
          ws.close()
        };

        ws.onmessage = function(message) {
          console.log("refreshing progress bar...");
          console.log(message.data);
          monitor.update_bar(message.data);
        };

        ws.onerror = function(message) {
          console.log(message);
        }
      }
      catch (e) {
        console.log(e);
        console.log("Unable to establish WebSocket connection.");
      }
    });
